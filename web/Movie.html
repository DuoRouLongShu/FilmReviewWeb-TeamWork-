<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Movie</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <!--<script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>-->
    <!--<script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>-->
    <!--[endif]-->

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <!--星星打分js插件-->
    <script type="text/javascript" src="js/markingSystem.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="js/bootstrap.min.js"></script>
</head>
<script>

    // 请求获得相应的电影名称,地址栏获得
    var MovieName ;
    // 特定电影评论的总页数和总条数，每页固定5条
    var totalPage;
    var totalCount;
    // 当前页码数，初始第一页
    var currentPage = 1;
    // 评论的对象、内容（名字、时间、评分、评论）、点赞数
        var comments;
    // 点赞的用户，仅用于测试。实际运行不需要
    var userName = "马志鹏";
        //更新的数据，目前只用来处理点赞数，用一条记录多次更新，会有多次记录，有冗余，遍历是一条路。初始索引0的值是电影名
        var data = [{"fileName":MovieName}];
        // data数据的下标
        var j = 0;
        // 地址栏获取参数的方法
        function GetRequest() {
            var url = decodeURI(location.search); //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for(var i = 0; i < strs.length; i ++) {
                    theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        }
        // 点赞数的增加与保存，要个人中心的userName、评论的reviewId，
        function count(obj) {
            var n = $(obj).prop("id").substring(4,5); // 页面上第1~5评论
            // 改变点赞数后要记得保存到数据,currentPage、div包裹的内容，先弄comment的likes，
            var i = totalCount - (currentPage - 1) * 5 - parseInt(n);     // 因为评论是逆序，数据库的第i条,和comment的下标有出入，出错就GG
            // 同一个对象只能对同一评论点一次赞，前端保存的仅是评论的点赞数。
            var addLike = $(obj).html(parseInt($(obj).html())+1); // 这addLike是对象？
            comments.data[i].likes = addLike[0].innerText;
            //即时请求更新数据库，不影响操作。记录的是，谁为哪条评论点了赞。
            $.ajax({
                url:"",
                data:{"userName":userName,"reviewId":comments.data[i].reviewId},
                type:"post",
                success:function (data) {
                    console.log("成功");
                }
            })
        }
        // 测试，或许能简化点赞数的html语句，不够也好不到那去
        // function countt(obj) {
        //     console.log(($(obj).children().html(parseInt($(obj).children().html())+1))[0].innerText);
        // }
        // 上一页和下一页的操作：翻页操作
        function special(obj) {
            if($(obj).prop("id") == "next"){
                currentPage = parseInt(currentPage) + 1;
            }else{
                currentPage -= 1;
            }
            if (currentPage <= 1) {
                currentPage = 1;
                $("#previous").parent().prop("class", "disabled");
            }else if(currentPage >= totalPage) {
                currentPage = totalPage;
                $("#next").parent().prop("class", "disabled");
            }
            fun(currentPage);
        }
    // 添加不同分页的评论内容
    function fun(page) {
        $("li[class='active']").prop("class","");
        var lis = $("#li li");
        lis.each(function (index, element) {
            if(index == page - 1){
                $(element).prop("class","active");
                return false;
            }
        });
        // i 的位置需要注意，可能错在这
        currentPage = page;
        if (currentPage <= 1) {
            currentPage = 1;
            $("#previous").parent().prop("class", "disabled");
        }else if(currentPage >= totalPage) {
            currentPage = totalPage;
            $("#next").parent().prop("class", "disabled");
        }else{
            $("#previous").parent().prop("class", "");
            $("#next").parent().prop("class", "");
        }
        i = (totalCount - 1 ) - (currentPage - 1) * 5;
        $("#name1").html(comments.data[i].userName);
        $("#comment1").html(comments.data[i].text);
        $("#title1").html(comments.data[i].title);
        $("#like1").html(comments.data[i].likes);
        $("#time1").html(comments.data[i].creatDate);
        // $("#rate1").html(comments.data[i].rating);
        $("#star_grade1").html("");
        $("#star_grade1").markingSystem({
            num: 10,
            havePoint: true,
            haveGrade: true,
            unit: '分',
            grade: comments.data[i].rating,
            height: 20,
            width: 20
        });
        i--;
        if(i >= 0) {
            $("#name2").html(comments.data[i].userName);
            $("#comment2").html(comments.data[i].text);
            $("#title2").html(comments.data[i].title);
            $("#like2").html(comments.data[i].likes);
            $("#time2").html(comments.data[i].creatDate);
            $("#rate2").html(comments.data[i].rating);
        }
        i--;
        if(i >= 0) {
            $("#name3").html(comments.data[i].userName);
            $("#comment3").html(comments.data[i].text);
            $("#title3").html(comments.data[i].title);
            $("#like3").html(comments.data[i].likes);
            $("#time3").html(comments.data[i].creatDate);
            $("#rate3").html(comments.data[i].rating);
        }
        i--;
        if(i >= 0) {
            $("#name4").html(comments.data[i].userName);
            $("#comment4").html(comments.data[i].text);
            $("#title4").html(comments.data[i].title);
            $("#like4").html(comments.data[i].likes);
            $("#time4").html(comments.data[i].creatDate);
            $("#rate4").html(comments.data[i].rating);
        }
        i--;
        if(i >= 0) {
            $("#name5").html(comments.data[i].userName);
            $("#comment5").html(comments.data[i].text);
            $("#title5").html(comments.data[i].title);
            $("#like5").html(comments.data[i].likes);
            $("#time5").html(comments.data[i].creatDate);
            $("#rate5").html(comments.data[i].rating);
        }
    }

    // 回复页面，跳转到另一个资源
    function reply(obj) {
        var userName = $(obj).parent().children().children().html();//对应名字
        var creatDate = $(obj).parent().children().next().children().html();//对应时间
        var rating = $(obj).parent().children().next().children().next().children().html();//对应评分
        var title = $(obj).parent().children().next().next().html();//对应标题
        var comment = $(obj).parent().children().next().next().next().next().html();//对应评论
        //存储变量的值
        localStorage.userName = userName;
        localStorage.creatDate = creatDate;
        localStorage.rating = rating;
        localStorage.title = title;
        localStorage.comment = comment;
        location.href = 'http://localhost:8080/FilmReviewWeb/CommentArea.html';
    }
    $(function (){
        // 地址栏获取电影名？
        var json = GetRequest();
        MovieName = json.filmName;
        // 评论区（json）
        $.ajax({
            // 去Servlet里查询所有该电影的影评，以及总页数，返回一个json对象，包含总记录数等
            url:"http://localhost:8080/FilmReviewWeb/filmpage/getReviews",
            // 包括电影名以及需要更新的点赞数
            data:{"filmName":MovieName},
            type:"post",
            success:function(data){
                comments = data;
                totalPage = data.pageCount;
                totalCount = data.dataCount;
                $("#totalCount").html(totalCount);
                // 分页
                for (var i = 1; i <= totalPage; i++) {
                    // 分页的按钮
                    $("#li").append("<li><a href='javascript:void(0)' onclick=fun(this.innerHTML); >"+i+"</a></li>");
                }
                $("#li li:first").prop("class","active");
                // 刚开始的显示内容,本来是按下标totalCount-1来写的，现在改为直接调用方法
                fun(currentPage);
            },
            dataType:"json"
        });

        $.ajax({
            url:"http://localhost:8080/FilmReviewWeb/filmpage/getData",
            data:{"filmName":MovieName},
            type:"post",
            success:function (data) {
                // 为页面添加真实内容
                $(".time").html(data.data.releaseDate);
                $(".filmName").html(data.data.filmName);
                // $("#rating").html(data.data.rating);
                $("#star_grade").markingSystem({
                    num: 10,
                    havePoint: true,
                    haveGrade: true,
                    unit: '分',
                    grade:data.data.rating,
                    height: 20,
                    width: 20
                })
                $("#area").html(data.data.area);
                $("#director").html(data.data.director);
                $("#writer").html(data.data.writer);
                $("#performer").html(data.data.performer);
                $("#genre").html(data.data.genre);
                $("#language").html(data.data.language);
                $("#duration").html(data.data.duration);
                $("#synopsis").html(data.data.synopsis);
            },
            dataType:"json"
        });

        $(".write").click(function () {
            // 需要换路径啊！！！！！！
            // window.location.href = "http://localhost:8080/FilmReviewWeb/WriteComment.html?filmName"+data.data.filmName;
            window.location.href = "http://localhost:8080/FilmReviewWeb/WriteComment.html";
        });
        // $("#collect").click(function () {
        //     alert("collect")
        // });


    });
</script>
        <style>
            body{

            }
            #myMargin{
                margin-left: 200px;
                margin-right: 250px;
            }
            #search{
                margin-left: 300px;
                width: 500px;
            }
            .name{
                font-weight: 900;
                font-size: 30px;
            }
            .time{
                font-size: 30px;
                color: #9d9d9d;
            }
            .information{
                font-size: 20px;
            }
            .t{
                 margin-top: 10px;
                 margin-left: 30px;
             }
            .color{
                color: green;
            }
            .p{
                font-size:large;
                font-weight: bold;
                color: darkred;
            }
            textarea{
                resize: none;
            }
            .set_image_all {
                cursor: pointer;
                position: relative;
            }

            .set_image_all .set_image_item {
                position: relative;
                display: inline-block;
                z-index: 11;
                visibility: visible;
            }

            .set_image_all .set_image_top {
                position: absolute;
                left: 0;
                top: 0;
                z-index: 10;
            }

            .set_image_all .set_image_top>div {
                display: inline-block;
                overflow: hidden;
            }

            .set_image_all .set_image_top>div>img {
                height: 100%;
            }

            .grade {
                vertical-align: center;
            }
            .lan{
                color: #2aabd2
            }
        </style>

<body>
    <!--导航条-->
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">首页</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <form class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="请输入你要搜索的电影名称" id="search">
                    </div>
                    <button type="submit" class="btn btn-default">搜索</button>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#">个人中心</a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
<div id="myMargin">
    <span class="name t filmName" style="margin-left: 40px">电影名称 </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="time">时间</span>)<br>
    <div class="row t">
        <div class="col-md-5"><img src="img/45d30c6591fc702987439347f480a426.jpg" alt="电影海报" height="100%" width="100%" ></div>
        <div class="col-md-7 information">
            导演:    <span id="director">名字</span><br>
            编剧:    <span id="writer">名字</span><br>
            主演:    <span id="performer">  名字</span><br>
            类型:    <span id="genre">名字</span><br>
            制片地区:    <span id="area">名字</span><br>
            评分:    <span id="star_grade"></span><br>
            语言:    <span id="language">语言</span><br>
            片长:    <span id="duration">片长</span><br>
            梗概:    <span id="synopsis">梗概</span><br>
        </div>
    </div>
    <input type="button" class="btn btn-default t write" value="写影评" style="margin-left: 40px">
    <input type="button" class="btn btn-default t btn-info" value="收藏" id="collect">
    <input type="button" class="btn btn-default t btn-warning" value="分享到" >
    <br><br><br>
    <div>
        <h2 class="t">网友影评</h2>
        <div style="margin-top: 20px;margin-left: 30px;font-size: large">
            <div class="color" style="float: left;"><span class="filmName">电影名字</span>影评···········</div>
            <div style="vertical-align: middle;color: green;">共<span id="totalCount"></span>条记录</div>
        </div>
        <input type="button" class="btn btn-default write" value="我要写影评" style="float: right;margin-right: 60px">
    </div>
    <br>

     <!--评论区-->
    <div class="t">
        <div id="1">
            <div style="float: left;margin-top: 4px"><span id="name1" style="color: #2aabd2">用户名字</span> 看过</div>
            <div style="color: #9d9d9d;">&nbsp;&nbsp;&nbsp;(<span id="time1">评论时间</span>)&nbsp;&nbsp;&nbsp;<span style="color: gold;font-size: large;font-weight: 700">评分:  <!--<span id="rate1">5.0</span>-->
                <span id="star_grade1"></span></span>
            </div>
            <span id="title1" class="p">标题</span><br>
            <textarea cols="132" rows="5" id="comment1"  readonly>评论导入</textarea><br>
            <span class="lan">点赞</span><a href="javascript:void(0)" onclick=count(this); id="like1">0</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a class="lan" href="javascript:;" onclick=reply(this)>全部回复<span>0</span></a>
        </div>
        <br><br>
        <div id="2">
            <div style="float: left;;margin-top: 4px"><span id="name2" style="color: #2aabd2">用户名字</span> 看过</div>
            <div style="color: #9d9d9d">&nbsp;&nbsp;&nbsp;(<span id="time2">评论时间</span>)&nbsp;&nbsp;&nbsp;<span style="color: gold;font-size: large;font-weight: 700">评分:  <span id="rate2">5.0</span></span>
            </div>
            <span id="title2" class="p">标题</span><br>
            <textarea cols="132" rows="5" id="comment2"  readonly>评论导入</textarea><br>
            <span class="lan">点赞</span><a href="javascript:void(0)" onclick=count(this); id="like2">0</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a class="lan" href="javascript:;" onclick=reply(this)>全部回复<span>0</span></a>
        </div>
        <br><br>

        <div id="3">
            <div style="float: left;;margin-top: 4px"><span id="name3" style="color: #2aabd2">用户名字</span> 看过</div>
            <div style="color: #9d9d9d">&nbsp;&nbsp;&nbsp;(<span id="time3">评论时间</span>)&nbsp;&nbsp;&nbsp;<span style="color: gold;font-size: large;font-weight: 700">评分:  <span id="rate3">5.0</span></span>
            </div>
            <span id="title3" class="p">标题</span><br>
            <textarea cols="132" rows="5" id="comment3"  readonly>评论导入</textarea><br>
            <span class="lan">点赞</span><a href="javascript:void(0)" onclick=count(this); id="like3">0</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a class="lan" href="javascript:;" onclick=reply(this)>全部回复<span>0</span></a>
        </div>
        <br><br>

        <div id="4">
            <div style="float: left;;margin-top: 4px"><span id="name4" style="color: #2aabd2">用户名字</span> 看过</div>
            <div style="color: #9d9d9d">&nbsp;&nbsp;&nbsp;(<span id="time4">评论时间</span>)&nbsp;&nbsp;&nbsp;<span style="color: gold;font-size: large;font-weight: 700">评分:  <span id="rate4">5.0</span></span>
            </div>
            <span id="title4" class="p">标题</span><br>
            <textarea cols="132" rows="5" id="comment4"  readonly>评论导入</textarea><br>
            <span class="lan">点赞</span><a href="javascript:void(0)" onclick=count(this); id="like4">0</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a class="lan" href="javascript:;" onclick=reply(this)>全部回复<span>0</span></a>
        </div>
        <br><br>

        <div id="5">
            <div style="float: left;;margin-top: 4px"><span id="name5" style="color: #2aabd2">用户名字</span> 看过</div>
            <div style="color: #9d9d9d">&nbsp;&nbsp;&nbsp;(<span id="time5">评论时间</span>)&nbsp;&nbsp;&nbsp;<span style="color: gold;font-size: large;font-weight: 700">评分:  <span id="rate5">5.0</span></span>
            </div>
            <span id="title5" class="p">标题</span><br>
            <textarea cols="132" rows="5" id="comment5" readonly>评论导入</textarea><br>
            <span class="lan">点赞</span><a href="javascript:void(0)" onclick=count(this); id="like5">0</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a class="lan" href="javascript:;" onclick=reply(this)>全部回复<span>0</span></a>
        </div>
        <br><br>
    </div>

</div>

    <!--分页条-->
    <nav aria-label="Page navigation" style="text-align: center;margin-bottom: 80px">
        <ul class="pagination">
            <li>
                <a href="javascript:void(0)" aria-label="Previous" id="previous" onclick=special(this)>
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <!--页数-->
            <ul class='pagination' id="li" style="margin-top:1px;"></ul>
            <li style="float: right;">
                <a href="javascript:void(0)" aria-label="Next" id="next" onclick=special(this) >
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>

</body>
</html>